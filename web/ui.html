<html>

  <head>
      <title>Uhoh</title>
  </head>

  <style>

      body
      {
        margin: 0;
      }

      .alert_red
      {
        margin-top: 0px;
        background-color: #EF0000;
        color: #dddddd;
        font-family: 'Roboto', arial, sans-serif;
        font-size: 14pt;
        font-weight: normal;
        padding: 10px;
      }

      .alert_amber
      {
        margin-top: 0px;
        background-color: #FCA800;
        color: #666666;
        font-family: 'Roboto', arial, sans-serif;
        font-size: 14pt;
        font-weight: normal;
        padding: 10px;
      }

      .alert_green
      {
        margin-top: 0px;
        background-color: #ffffff;
        color: #999999;
        font-family: 'Roboto', arial, sans-serif;
        font-size: 14pt;
        font-weight: normal;
        padding: 10px;
      }

      .chartbar
      {
        background-color: #ffffff;
        color: #000000;
        font-family: 'Roboto', arial, sans-serif;
        font-size: 14pt;
        font-weight: bold;
        padding: 10px;
        position: fixed;
        height: 150px;
        width: 90%;
      }

  </style>

  <link href='https://fonts.googleapis.com/css?family=Roboto:300' rel='stylesheet' type='text/css'>

  <script src="https://ajax.googleapis.com/ajax/libs/mootools/1.5.2/mootools.min.js"></script>

  <script type="text/javascript"
          src="https://www.google.com/jsapi?autoload={
            'modules':[{
              'name':'visualization',
              'version':'1',
              'packages':['corechart']
            }]
          }">
  </script>

  <script>

      var datatable = null;
      var chartoptions = null;
      var chart = null;

      var max_chart_rows = 2160; // Twelve hours.

      window.addEvent('domready', function()
      {
        chart = new google.visualization.LineChart(document.getElementById('alertchart'));

        datatable = new google.visualization.DataTable();
        datatable.addColumn('timeofday', 'Time of Day');
        datatable.addColumn('number', 'Red');
        datatable.addColumn('number', 'Amber');
        datatable.addColumn('number', 'Green');

        chartoptions = {
          title: 'Alert History',
          titlePosition: 'none',
          curveType: 'none',
          hAxis: { viewWindowMode: 'pretty', textStyle: { color: '#666666', fontName: 'Roboto, arial, sans-serif', fontSize: 12 } },
          vAxis: { minValue: 0, logScale: false, textStyle: { color: '#666666', fontName: 'Roboto, arial, sans-serif', fontSize: 12 } },
          chartArea: { left: 100, top: 5, width: '70%', height: '80%' },
          legend: { position: 'right', textStyle: { color: '#666666', fontName: 'Roboto, arial, sans-serif', fontSize: 12 } },
          series: { 0: { color: '#EF0000', lineWidth: 4 }, 1: { color: '#FCA800', lineWidth: 2 }, 2: { color: '#00FF00', lineWidth: 1 } }
        };

        do_fetch();
      });

      function do_fetch()
      {
        var ajax = new Request({ noCache: true, url: "/ui", onSuccess: function(responseText, responseXML) { do_render(responseText) }, onFailure: function() { errbox() }, onException: function() { errbox() } });
        ajax.get();

        setTimeout(function() { do_fetch(); }, 20000);
      }

      function do_render(responseText)
      {
        var obj = JSON.decode(responseText);
        var response = "<div class=\"chartbar\" style=\"position: static;\"></div>";

        if(obj.status != "ok")
        {
          alert("The server returned an error");
        }
        else
        {
          response += get_alerts(obj.red, "alert_red");
          response += get_alerts(obj.amber, "alert_amber");
          response += get_alerts(obj.green, "alert_green");

          var d = new Date();

          datatable.addRow([[ d.getHours(), d.getMinutes(), d.getSeconds() ], obj.red.length, obj.amber.length, obj.green.length ]);

          if(datatable.getNumberOfRows() > max_chart_rows)
          {
            datatable.removeRow(0);
          }
        }

        $('alerts').innerHTML = response;

        chart.draw(datatable, chartoptions);
      }

      function get_alerts(aobj, categ)
      {
        var html = "";

        for(var i = 0; i < aobj.length; i ++)
        {
          html += ( "<div class=\"" + categ + "\">" + aobj[i] + "</div>" );
        }

        return(html);
      }

      function errbox()
      {
        alert("Error calling the server");
      }

      function toggle_menu()
      {
        var curr_menu_sz = document.getElementById('topmenu').style.height.replace('px', '');

        if(curr_menu_sz == '')
        {
          curr_menu_sz = 50;
        }

        var new_menu_sz = 450 - curr_menu_sz;
        document.getElementById('topmenu').style.height = new_menu_sz + "px";
      }

  </script>

  <body>

    <div class="chartbar" id="alertchart"></div>
    <div id="alerts"></div>

  </body>

</html>