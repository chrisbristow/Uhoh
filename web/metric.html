<html>

  <head>
    <title>_URL_</title>

    <style>

      body
      {
        margin: 0;
        background-color: #ffffff;
      }

      .cat
      {
        font: bold 12pt 'Roboto', arial, sans-serif;
      }

    </style>

    <link href='https://fonts.googleapis.com/css?family=Roboto:300' rel='stylesheet' type='text/css'>

    <script src="https://ajax.googleapis.com/ajax/libs/mootools/1.5.2/mootools.min.js"></script>

    <script type="text/javascript"
            src="https://www.google.com/jsapi?autoload={
            'modules':[{
              'name':'visualization',
              'version':'1',
              'packages':['corechart']
            }]
          }">
    </script>

    <script>

      var datatable = null;
      var chartoptions = null;
      var chart = null;

      window.addEvent('domready', function()
      {
        chart = new google.visualization.AreaChart(document.getElementById('chart'));

        chartoptions = {
          title: '_URL_',
          titlePosition: 'out',
          curveType: 'none',
          hAxis: { viewWindowMode: 'pretty', textStyle: { color: '#666666', fontName: 'Roboto, arial, sans-serif', fontSize: 12 }, format: 'dd/MM/yyyy HH:mm', title: 'Time' },
          vAxis: { minValue: 0, logScale: false, textStyle: { color: '#666666', fontName: 'Roboto, arial, sans-serif', fontSize: 12 }, title: '_METRIC_' },
          chartArea: { width: '60%', height: '40%' },
          legend: { position: 'none', textStyle: { color: '#666666', fontName: 'Roboto, arial, sans-serif', fontSize: 12 } },
          series: { 0: { color: '#EF0000', lineWidth: 1 }, 1: { color: '#FCA800', lineWidth: 1 }, 2: { color: '#00FF00', lineWidth: 1 } }
        };

        do_fetch(document.title);
      });

      function do_fetch(title)
      {
        var ajax = new Request({ noCache: true, url: "/mdata/" + title + "/", onSuccess: function(responseText, responseXML) { do_render(responseText) }, onFailure: function() { errbox() }, onException: function() { errbox() } });
        ajax.get();
        setTimeout(function() { do_fetch(title); }, 60000);
      }

      function do_render(responseText)
      {
        var obj = JSON.decode(responseText);

        if(obj.status != "ok")
        {
          $('chart').innerHTML = "No chart data available (" + chartoptions.title + ")";
        }
        else
        {
          datatable = null;
          datatable = new google.visualization.DataTable();
          datatable.addColumn('datetime', 'Time');
          datatable.addColumn('number', 'Value')

          for(var i = 0; i < obj.items.length; i ++)
          {
            datatable.addRow([ new Date(obj.items[i][0], obj.items[i][1] - 1, obj.items[i][2], obj.items[i][3], obj.items[i][4], obj.items[i][5], 0), obj.items[i][6]]);
          }

          chart.draw(datatable, chartoptions);
        }

        var dt = new Date();
        var u_parts = chartoptions.title.split('/');

        if(u_parts[0].match(/^(\d\d\d\d)\-(\d\d)\-(\d\d)$/) != null)
        {
          var ddc = u_parts[0].match(/^(\d\d\d\d)\-(\d\d)\-(\d\d)$/);

          dt = new Date(ddc[1], ddc[2] - 1, ddc[3], 12, 0, 0, 0);
        }

        var d_back = new Date(dt.getTime() - 86400000);
        var d_fwd = new Date(dt.getTime() + 86400000);

        var y_date = d_back.getFullYear() + "-" + pad(d_back.getMonth() + 1) + "-" + pad(d_back.getDate());
        var t_date = d_fwd.getFullYear() + "-" + pad(d_fwd.getMonth() + 1) + "-" + pad(d_fwd.getDate());

        $('controls').innerHTML = "<input type='button' value='&lt;' onmouseup='location.href = \"/metric/" + y_date + "/" + u_parts[1] + "/" + chartoptions.vAxis.title + "\";' /> <input type='button' value='O' onmouseup='location.href = \"/metric/TODAY/" + u_parts[1] + "/" + chartoptions.vAxis.title + "\";' /> <input type='button' value='&gt;' onmouseup='location.href = \"/metric/" + t_date + "/" + u_parts[1] + "/" + chartoptions.vAxis.title + "\";' />";
      }

      function pad(x)
      {
        var r = x + "";

        if(x < 10)
        {
          r = "0" + x;
        }

        return(r);
      }

      function errbox()
      {
        $('controls').innerHTML = "Error calling the server";
      }

    </script>

  </head>

  <body>

    <div id="chart" style="width: 100%; height: 90%; font-family: 'Roboto', arial, sans-serif; font-size: 12pt; font-weight: bold;"></div>

    <div id="controls" class="cat"></div>

  </body>

</html>